<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="unlogin-page">
    <button id="loginButton">登录</button>
    <h1>当前尚未登录</h1>
  </div>
  <div id="login-page" style="display: none;">
    <button id="whoamiButton">获取用户信息</button>
    <button id="logoutButton">登出</button>
    <h1>当前已登录</h1>
  </div>
</body>

<script>
  const APP_ID = '912cda9e-8c18-4aa6-928f-52dd13adbd06';

  const switchPage = (isLogin) => {
    if (isLogin) {
      document.getElementById('unlogin-page').style.display = 'none';
      document.getElementById('login-page').style.display = 'block';
    } else {
      document.getElementById('unlogin-page').style.display = 'block';
      document.getElementById('login-page').style.display = 'none';
    }
  };

  const getToken = () => {
    return localStorage.getItem(`$cube-auth-token-${APP_ID}`);
  };

  const checkLogin = () => {
    const token = getToken();
    if (!token) {
      switchPage(false);
      return;
    }

    switchPage(true);
  };

  checkLogin();

  const jumpToLogin = () => {
    window.location.href = `/login/${APP_ID}?redirect=${encodeURIComponent(window.location.href)}`;
  }

  const fetchUserInfo = async () => {
    const token = getToken();

    const response = await fetch('/api/user/me', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    const data = await response.json();
    if (!data.success) {
      alert(`token 已过期，点击确定重新登录`);
      jumpToLogin();
      return;
    }

    alert(`User Token:\n\n${token}\n\nUser Info: \n\n${JSON.stringify(data)}`);
  }

  const logout = () => {
    localStorage.removeItem(`$cube-auth-token-${APP_ID}`);
    switchPage(false);
  }

  document.getElementById('loginButton').addEventListener('click', jumpToLogin);
  document.getElementById('whoamiButton').addEventListener('click', fetchUserInfo);
  document.getElementById('logoutButton').addEventListener('click', logout);
</script>

</html>